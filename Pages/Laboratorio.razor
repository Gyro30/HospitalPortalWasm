@page "/laboratorio"
@inject IHospitalService DB

<h3>Laboratorio</h3>

<div class="row g-3">
    <div class="col-md-4">
        <h5>Crear orden</h5>
        <select class="form-select" @bind="_patientId">
            <option value="">-- Paciente --</option>
            @foreach (var p in patients)
            {
                <option value="@p.Id">@p.FullName (@p.Document)</option>
            }
        </select>
        <select class="form-select mt-2" @bind="_testTypeId">
            <option value="">-- Tipo de test --</option>
            @foreach (var t in testTypes)
            {
                <option value="@t.Id">@t.Code - @t.Name (S/. @t.Price)</option>
            }
        </select>
        <button class="btn btn-primary mt-2" @onclick="CrearOrden" disabled="@(!CanCreate)">Crear orden</button>

        <hr />
        <h6>Tipos de test</h6>
        <input class="form-control" placeholder="Código" @bind="_newCode" />
        <input class="form-control mt-1" placeholder="Nombre" @bind="_newName" />
        <input class="form-control mt-1" type="number" step="0.1" placeholder="Precio" @bind-value="_newPrice" />
        <button class="btn btn-outline-primary mt-2" @onclick="AgregarTipo">Agregar tipo</button>
    </div>

    <div class="col-md-8">
        <h5>Órdenes recientes</h5>
        <table class="table table-sm">
            <thead><tr><th>Fecha</th><th>Paciente</th><th>Test</th><th>Estado</th><th></th></tr></thead>
            <tbody>
                @foreach (var o in orders)
                {
                    var pac = patients.First(p => p.Id == o.PatientId);
                    var tt = testTypes.First(t => t.Id == o.TestTypeId);
                    <tr>
                        <td>@o.Date.ToString("dd/MM/yyyy HH:mm")</td>
                        <td>@pac.FullName</td>
                        <td>@tt.Code - @tt.Name</td>
                        <td>@(o.Status == LabOrderStatus.Pending ? "Pendiente" : "Con resultado")</td>
                        <td>
                            @if (o.Status == LabOrderStatus.Pending)
                            {
                                <button class="btn btn-sm btn-success" @onclick="() => AbrirResultado(o.Id)">Registrar resultado</button>
                            }
                            else
                            {
                                <span title="@o.ResultText">Ver</span>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@if (_showResultDialog)
{
    <div class="card p-3 mt-2">
        <h6>Resultado de la orden</h6>
        <textarea class="form-control" rows="3" @bind="_resultText"></textarea>
        <button class="btn btn-success mt-2" @onclick="GuardarResultado">Guardar</button>
        <button class="btn btn-link mt-2" @onclick="@(() => _showResultDialog = false)">Cancelar</button>
    </div>
}

@code {
    private List<Patient> patients = new(); private List<LabTestType> testTypes = new(); private List<LabOrder> orders = new();
    private string _patientId = ""; private string _testTypeId = "";
    private string _newCode = ""; private string _newName = ""; private decimal _newPrice = 0;
    private bool _showResultDialog = false; private Guid _orderToResult; private string _resultText = "";

    bool CanCreate => Guid.TryParse(_patientId, out _) && Guid.TryParse(_testTypeId, out _);

    protected override async Task OnInitializedAsync()
    {
        await DB.EnsureSeedAsync();
        patients = await DB.GetPatientsAsync();
        testTypes = await DB.GetTestTypesAsync();
        orders = await DB.GetLabOrdersAsync();
    }

    private async Task CrearOrden()
    {
        if (!CanCreate) return;
        await DB.CreateLabOrderAsync(Guid.Parse(_patientId), Guid.Parse(_testTypeId));
        orders = await DB.GetLabOrdersAsync();
    }

    private async Task AgregarTipo()
    {
        if (string.IsNullOrWhiteSpace(_newCode) || string.IsNullOrWhiteSpace(_newName)) return;
        await DB.AddTestTypeAsync(new LabTestType { Code = _newCode.Trim(), Name = _newName.Trim(), Price = _newPrice });
        testTypes = await DB.GetTestTypesAsync();
        _newCode = _newName = ""; _newPrice = 0;
    }

    void AbrirResultado(Guid id) { _orderToResult = id; _showResultDialog = true; _resultText = ""; }
    async Task GuardarResultado()
    {
        if (string.IsNullOrWhiteSpace(_resultText)) return;
        await DB.ResultLabOrderAsync(_orderToResult, _resultText.Trim());
        orders = await DB.GetLabOrdersAsync();
        _showResultDialog = false;
    }
}
